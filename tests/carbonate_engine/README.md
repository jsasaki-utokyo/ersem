# Carbonate Engine Test Harness

This directory contains an offline verification harness for the `carbonate_engine` module,
which provides a PyCO2SYS-compatible carbonate chemistry solver for ERSEM.

## Overview

The carbonate-engine solver (`src/carbonate_engine.F90`) computes pH and pCO2 from
DIC (dissolved inorganic carbon) and TA (total alkalinity) using robust root-finding
(Brent's method). This test harness validates the solver against reference values
generated by PyCO2SYS.

## Files

- `test_driver.f90` - Fortran test driver that reads reference cases and validates solver
- `reference_cases.csv` - Reference test cases (T, S, DIC, TA -> pH, pCO2)
- `generate_reference.py` - Python script to regenerate reference cases using PyCO2SYS
- `README.md` - This file

## Running the Tests

### Prerequisites

1. A Fortran compiler (gfortran, ifort, etc.)

### Compile and Run

```bash
cd tests/carbonate_engine

# Compile the test driver (standalone, no FABM dependencies)
gfortran -O2 -o test_driver test_driver.f90

# Run the tests
./test_driver reference_cases.csv
```

Expected output for a passing test:
```
==================================================
Carbonate Engine Test Driver
==================================================

Reading reference cases from: reference_cases.csv

Case    1: PASS (pH=  8.074000, pCO2=  3.882E-04)
Case    2: PASS (pH=  8.149000, pCO2=  2.931E-04)
...

==================================================
Summary
==================================================
Total cases:   10
Passed:        10
Failed:          0

ALL TESTS PASSED
```

### Exit Codes

- `0` - All tests passed
- `1` - One or more tests failed, or no test cases found

## Regenerating Reference Cases

The reference cases are generated using PyCO2SYS. To regenerate:

```bash
# Install PyCO2SYS if not already installed
pip install PyCO2SYS

# Generate reference cases
python generate_reference.py
```

This will overwrite `reference_cases.csv` with fresh values from PyCO2SYS.

**Important:** The `generate_reference.py` script is for developer use only and is
NOT used at runtime by ERSEM. The Fortran solver does not depend on Python.

## PyCO2SYS Settings

The reference cases use the following PyCO2SYS settings to match the carbonate_engine
implementation:

| Setting | Value | Description |
|---------|-------|-------------|
| opt_k_carbonic | 10 | Millero (2010), total pH scale |
| opt_k_bisulfate | 1 | Dickson (1990) |
| opt_k_fluoride | 2 | Perez & Fraga (1987) |
| opt_total_borate | 2 | Lee et al. (2010) |
| opt_pH_scale | 1 | Total scale |

## Tolerances

Tests pass if the calculated values are within:

- pH: ±0.001 (absolute)
- pCO2: ±2 µatm = ±2e-6 atm (absolute)

## ERSEM Integration

To use the carbonate-engine in ERSEM simulations:

1. Set `engine: 1` in your FABM YAML configuration for the carbonate model
2. The default (`engine: 0`) uses the legacy ERSEM carbonate solver

Example YAML configuration:
```yaml
ersem_carbonate:
  iswCO2: 1
  iswtalk: 5
  pHscale: 1
  engine: 1  # Use carbonate-engine solver
```

## Troubleshooting

### Solver convergence failures

If the solver fails to converge for certain conditions:
1. Check that DIC and TA values are in mol/kg (not mmol/m³ or µmol/kg)
2. Ensure T and S are within typical marine ranges
3. The solver uses pH bounds [2, 12]; extreme cases may need adjustment

### Discrepancies with PyCO2SYS

Small differences (~0.001 pH, ~1 µatm pCO2) are expected due to:
- Minor differences in constant formulations
- Numerical precision in root-finding

Larger discrepancies may indicate:
- Different pH scale settings
- Missing pressure corrections
- Errors in constant calculations

Report issues to the ERSEM development team.
