# 修正: 溶存酸素の非負制約と底質交換の不安定性

## 概要

ERSEMの溶存酸素（O2）状態変数に非負制約が設定されていなかったため、1D
GOTM-ERSEMシミュレーションの底層で物理的にあり得ない値が発生した。具体的には、
極端な負値（-2158 mmol/m3 = -69 mg/L）と極端な正値（+4542 mmol/m3 = +145 mg/L、
飽和の約15倍）の間で振動が起きた。原因は、O2状態変数の非負制約の欠如と、底質
カラム溶存物質モジュールにおける正のフィードバックループの組み合わせであった。

## 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/oxygen.F90` | O2状態変数登録に `minimum=0` を追加 |
| `src/benthic_column_dissolved_matter.F90` | O2成分の `nonnegative=legacy_ersem_compatibility` (.false.) を `nonnegative=.true.` に変更 |

ホストモデルのODEソルバー変更は不要である（後述の「ODEソルバー互換性」を参照）。
ソースコード修正のみで前進オイラー法でも安定する。

## バグの詳細

### 症状

東京湾（川崎人工島地点、水深20m、鉛直30層）の1D GOTM-ERSEMシミュレーションに
おいて、夏季成層期に底層の溶存酸素が壊滅的な振動を示した：

- O2が-2158 mmol/m3まで低下（物理的には-69 mg/L）
- O2が+4542 mmol/m3まで急上昇（物理的には+145 mg/L、飽和の約15倍）
- 振動は約4日周期で数週間持続

### 原因分析

不安定性は3つの要因の相互作用により発生した：

#### 1. O2状態変数に `minimum=0` が未設定（`oxygen.F90`）

O2状態変数が下限値なしで登録されていた：

```fortran
! 修正前（バグ）
call self%register_state_variable(self%id_O2o,'o','mmol O_2/m^3','oxygen',300._rk)
```

GOTMにおいて2つの影響があった：
- **`repair_state`**（変数を[minimum, maximum]にクリップする機能）が、最小値がないため機能しなかった
- **`posconc`** フラグが0に設定された（`minimum >= 0` の場合のみ1になる）ため、鉛直拡散ソルバーの正値性制約が無効だった

結果として、前進オイラー法の時間積分でO2が自由に負値になり得た。

#### 2. 底質O2の `nonnegative=.false.`（`benthic_column_dissolved_matter.F90`）

底質カラム溶存物質モジュールで、O2成分が以下のように登録されていた：

```fortran
! 修正前（バグ）
call initialize_constituent(..., 'o', ..., nonnegative=legacy_ersem_compatibility)
```

`legacy_ersem_compatibility = .false.`（`shared.F90` で定義）のため、O2成分は
`nonnegative = .false.` となっていた。これにより：
- 底質O2のPatankarトリックが無効化
- `c_int_deep`（底質プロファイルのゼロ等値線以深のO2質量）が有効化

#### 3. 平衡プロファイルによる増幅メカニズム

底質カラム溶存物質モジュールは、底質内のO2平衡プロファイルを放物線（二次関数）
で計算する。この放物線の曲率は `P / sigma` に比例する（Pは生成/消費速度、sigma
は底質拡散係数）。

典型的なERSEMパラメータでは：
- 底質拡散係数：EDZ = 5 × 10^-5 m2/d（極めて小さい）
- これにより平衡プロファイルの曲率が約50,000 m^-2と巨大になる

海水側O2がわずかに負値（約-20 mmol/m3）になると、深さ積分した平衡O2
（`c_int_eq`）が約-1000〜-1300 mmol/m2まで急落する。

底質-海水間交換フラックスは以下の式で計算される：

```
exchange = sms + (c_int + c_int_deep - c_int_eq) / relax
```

海水側O2が初めてわずかに負値になった時：

1. `c_int_eq` が約-1000 mmol/m2に急変（小さな拡散係数による巨大な曲率のため）
2. `c_int_deep` は約-26 mmol/m2のまま（まだ追いついていない）
3. 不一致 `(c_int + c_int_deep - c_int_eq)` が約+974 mmol/m2
4. `relax`（5日）で割ると約+195 mmol/m2/dのO2フラックスが海水側に注入される
5. 底層セルの高さ（約0.667m）で割ると約+292 mmol/m3/d ── 底層セルへの巨大なO2供給源

この正のフラックスが**海水側にO2を大量に注入する**。その後約4日かけて
`c_int_deep` が `c_int_eq` に緩和し、やがてオーバーシュートする。交換が逆転
すると、O2は再び負に駆動され、サイクルが繰り返される。

診断結果は決定的だった：
- `G2_o_pb_flux` が+10,577 mmol/m2/d（海水側で+15,865 mmol/m3/d）に到達
- `G2_o_deep` が-26から-16,620 mmol/m2まで減少
- `D1m`（酸化層厚）は全期間 `minD` = 0.0001 m に固定

### 典型的な振動サイクルの時系列

```
7月15日: O2 = -20 mmol/m3（呼吸によりわずかに負値）
         c_int_eq が約-1000 mmol/m2に急変
         G2_o_deep = -26 mmol/m2（遅れている）
         → exchange = +195 mmol/m2/d（正 = O2が海水側に注入）

7月16日: O2が+1000〜4500 mmol/m3に急上昇（大量注入）
         G2_o_deep がc_int_eqに向かって急速に減少中

7月17-19日: O2は高い値を維持（1000〜4000 mmol/m3）
            G2_o_deep はまだ緩和中、交換フラックスは減少

7月20日: G2_o_deep がc_int_eqをオーバーシュート
         交換が逆転 → O2が底質側に引き戻される
         O2が-2000 mmol/m3に急落
         サイクルが繰り返される可能性あり
```

## 修正内容

### 修正1: O2に `minimum=0` を追加（`oxygen.F90` 51行目）

```fortran
! 修正後
call self%register_state_variable(self%id_O2o,'o','mmol O_2/m^3','oxygen',300._rk,minimum=0._rk)
```

これにより：
- `repair_state` が各タイムステップ後にO2を [0, ∞) にクリップ
- `posconc = 1` により鉛直拡散ソルバーの正値性制約が有効化
- そもそもO2が負値になることを防止

**根拠**: 硫酸還元が明示的にモデル化されている場合（例：`pel_sulfur`モジュール）、
酸素負債はH2S濃度として適切に追跡される。元のERSEM設計で負のO2を「酸素負債の
代理変数」として許容していた仕様は不要となった。

### 修正2: 底質O2を `nonnegative=.true.` に設定（`benthic_column_dissolved_matter.F90` 127行目）

```fortran
! 修正後
call initialize_constituent(..., 'o', ..., nonnegative=.true.)
```

これにより：
- 底質O2交換計算にPatankarトリックが適用される
- `c_int_deep` が無効化（ゼロ等値線以深の負質量の追跡を停止）
- 平衡プロファイルによる増幅メカニズムが完全に防止される

### `fabm.yaml` に関する注意

修正2により底質O2成分は `c_int_deep` を登録しなくなるため、`fabm.yaml` の
`o_deep` 初期化キーを削除する必要がある：

```yaml
# 修正前（修正後は「setting not recognized」エラーになる）
G2:
  initialization:
    o: 0.015
    o_deep: 0       # ← この行を削除

# 修正後
G2:
  initialization:
    o: 0.015
```

## ODEソルバー互換性

### EMP2はERSEMと非互換

テストの結果、拡張修正Patankar法（EMP2）ODEソルバーは**ERSEMでは動作しない**
ことが判明した。GOTMで `ode_method: emp2` を使用すると、全状態変数がシミュレーション
全期間を通じて初期値のまま変化しない（O2は265 mmol/m3、Chl-aは4.1 mg/m3で固定、
時間変動ゼロ）。

これはEMP2がソースタームの生成-消滅分解（PPDD）を必要とするためである。ERSEMの
生化学ソースタームはこの分解を正しく提供する構造になっておらず、ソルバーが実質的
に全レートをゼロにしてしまう。

### 前進オイラー法はソースコード修正のみで正常動作

前進オイラー法（`ode_method: fe`）とソースコード修正2点（修正1＋修正2）による
テスト結果は以下の通りである：

| 指標 | 修正前 | 修正後（FE） |
|------|--------|-------------|
| O2最小値 | -2158 mmol/m3 | **0.00 mmol/m3** |
| O2最大値 | +4542 mmol/m3 | **471 mmol/m3** |
| 負値O2セル | 多数 | **0** (0.0000%) |
| O2 > 500 mmol/m3 | 多数 | **0** (0.0000%) |
| G2_o_pb_flux範囲 | -2513〜+10577 | **-619〜-0.08** |
| 底層O2（7月） | -903〜+4542 | **0.00〜16.8** |
| 底層O2（9月） | 振動 | **0.00〜2.6** |

修正により全ての負値O2と異常な正値スパイクが解消された。夏季成層期の底層無酸素
（O2=0）は底質交換の不安定性を引き起こすことなく正しく維持される。

### FVCOMおよびその他のホストモデルへの影響

これはGOTM以外のホストモデル（例：FVCOM）でERSEMを使用する場合に重要である。
FVCOMなどではModified Patankarソルバーが利用できない可能性がある。
**ソースコード修正（修正1＋修正2）のみで十分であり**、特殊なODEソルバーは不要
である。

前進オイラー法で安定性を確保する主要メカニズム：

1. **`minimum=0`**（修正1）：GOTMの `repair_state` がO2を [0, ∞) にクリップし、
   拡散ソルバーの正値性制約を有効化する。FVCOMでは同等のクリッピング機構を適用
   する必要がある。
2. **`nonnegative=.true.`**（修正2）：`c_int_deep` 状態変数を廃止し、底質モジュール
   内部でPatankarトリックを有効化する。これによりホストモデルのODEソルバーに依存
   せず平衡プロファイルの増幅メカニズムが防止される。

## 影響範囲

この修正は以下のERSEM設定で関連する：
1. 底層O2がゼロに近づき得る環境（富栄養化環境、深い成層水域など）
2. 底質カラム溶存物質モジュールがO2とともに使用されている場合
3. `legacy_ersem_compatibility = .false.`（現在のデフォルト）

この修正がない場合、底層貧酸素が発生するあらゆる設定で底質交換の不安定性が
発生するリスクがあり、非物理的なO2値やシミュレーション破綻につながる可能性がある。
